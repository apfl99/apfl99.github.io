---
title: "The Merge"
categories:
 - DankSharding
tags: [Ethereum 2.0, Vitalik Buterin’s Endgame, A rollup-centric ethereum roadmap] 
toc: true
author_profile: true #profile sidebar 감추기
# sidebar:
#     nav: "docs" # 목차 사이드바
search: true #검색 피하기




---

# The Merge

------

"The Merge"란 이더리움의 원래 실행 계층과 새로운 지분 증명 합의 계층인 Beacon Chain을 결합한 것이다. 

Beacon Chain은 원래 메인넷 트랜잭션을 처리하지 않고 유효성 검사자와 계정 잔액에 동의하여 자체 상태에 대한 합의만 담당하였지만, "The Merge"이후 Beacon Chain은 실행 계층 거래 및 계정 잔액을 포함한 모든 네트워크 데이터의 합의 엔진이 되었다.



## Beacon Chain



### Beacon Chain의 핵심 기능

---

Beacon Chain의 핵심 기능은 자체 및 모든 샤드 체인에 대한 지분 증명 프로토콜을 관리하는 것이다.

여기에는

- 유효성 검사기 및 해당 지분 관리
- 위원회와 제안자 구성
- 합의알고리즘 적용
- 합의 규칙 적용 검증자에게 보상 및 패널티 적용

가 있다.



### Beacon Chain의 자료 구조

---



#### BeaconState

---

BeaconState는 Beacon Block으로 구성된 체인의 상태 전이 함수를 실행한 결과 변경되는 비콘체인 자체의 상태를 의미한다. Beacon State에는 Fork 버전, 캐시 기록, ETH 1체인에 대한 정보, 검증자 목록, 검증자 랜덤 선정을 위한 랜덤성에 대한 정보, 과거 검증자 처벌 기록, 최근의 검증 투표, 최근의 크로스링크, 완결성(Finality)에 대한 정보등이 포함된다.

- Cross Link와 Shard
  - Cross Link : 샤드체인의 샤드블록의 상태들이 주기적으로 비콘체인에 기록되기 위한 참조 역할을 하는 데이터
    - 샤드 체인의 완결성 보장 목적
    - 각 샤드체인마다 비콘체인의 검증자 풀 중 일부가 샤드체인의 위원회로 구성되며, 해당 위원회가 샤드체인을 비콘체인과 크로스링크
    - 일반적인 경우 각 샤드는 비콘체인에 에폭당 한 번 기록



#### Beacon Block

---

Beacon Block은 Beacon Chain의 핵심 요소로, 헤더 부분과 블록 바디로 구성된다. 기존의 블록과 마찬가지로 Beacon Block의 헤더는 주로 바디에 포함된 정보나 현재 상태 데이터의 루트를 포함한다. 바디 부분은 비콘체인의 트랜잭션에 해당하는 데이터를 포함되며, 이는 주로 검증자들의 행동과 상태에 대한 내용들이 있다.



### Beacon Chain WorkFlow

----



#### 슬롯 및 에포크

----

- Slot : 12초
  - 시스템이 최적으로 실행될 때 1slot마다 하나의 블록 추가
  - 따라서 1slot마다 꼭 하나의 블록이 생성되는 것은 아님
- Epoch : 64개의 Slot
  - 에포크마다 검증인들이 랜덤하게 여러 위원회로 구분되어 선정



#### 유효성 검사기 관리 및 증명

---

유효성 검사기는 Ethereum의 합의를 실행한다.

검증자는 블록을 구축하기 위해 의사 무작위로 선택되며, 블록 제안자와 제안된 블록에 투표하는 증명자들(위원회)로 구성된다.



![Beacon-Chain-Validators](../../images/2023-02-06-TheMerge/Beacon-Chain-Validators.webp)

{: .align-center}

위와 같이 의사 무작위로 선택된 검증자는 각 슬롯마다 존재하며, 블록 제안자가 제안한 블록이 투표되면 제안자는 보상을 받는다.

또한, g와 같이 슬롯이 블록 제안자가 오프라인 상태이거나 Sync가 맞지 않아 제안되지 못할 경우 블록 제안자로 선택된 검증자는 보상을 받지 못한다.



여기서 증명은 유효성 검사기의 잔액에 가중치가 부여된 유효성 검사기의 투표이고, 증명은 블록 외에도 유효성 검사기에 의해 브로드 캐스트된다.

또한, 유효성 검사기는 서로를 감시하고 충돌하는 투표를 하거나 여러 블록을 제안하는 다른 유효성 검사기를 보고하여 보상을 받는다.



즉, 이더리움에서는 사용자가 ETH를 스테이킹하여 유효성 검사기를 활성화하고 제어한다.

이더리움에서는 32ETH 스테이킹마다 하나의 유효성 검사기가 활성화된다.

유효성 검사기는 Beacon Chain 노드를 사용하는 유효성 검사기 클라이언트에 의해 실행되며, 해당 클라이언트는 Beacon 노드 기능을 구현하거나 Beacon 노드를 호출할 수 있다.



#### 위원회

---

위원회는 유효성 검사기 그룹으로, 보안을 위해 각 슬롯에는 최소 128명의 유효성 검사기로 구성된다.

구성하는 방법은 공격자가 위원회를 통제하는 것을 방지하기 위해 Beacon Chain은 RANDAO라고하는 유사 무작위 프로세스로 구성한다.

![Beacon-Chain-RANDAO.png](../../images/2023-02-06-TheMerge/Beacon-Chain-RANDAO.png.webp)

{: .align-center}



위원회가 RANDAO를 통해 구성되면, 

![Beacon-Chain-Committees.png](../../images/2023-02-06-TheMerge/Beacon-Chain-Committees.png.webp)

{: .align-center}

위 그림과 같이 증명을 하게 되는데, 

- 위원회 A 중 2명의 검증자는 Alice가 제안한 블록을 슬롯 1로 증명하고, 1명의 검증자는 오프라인 상태이다.
- 위원회 B 중 2명의 검증자는 슬롯 2에 Bob이 제안한 블록을 슬롯 2로 증명하고, 1명의 검증자는 데이터를 잘못 받아 Alice가 제안한 블록을 슬롯 2로 증명했다.
- Eve가 제안한 블록의 경우 위원회 C의 모든 검증자가 슬롯 3으로 증명했다.

이 경우, 슬롯 2에서 체인이 나뉘는 포크가 발생하게 되는데, 이를 해결하기 위해 Beacon Chain에서는 LMD GHOST를 사용한다.



#### 비콘 체인 체크포인트

---

체크포인트는 에포크의 첫번째 슬롯에 있는 블록으로, 해당 블록이 없으면 체크포인트는 이전의 가장 최근 블록이다.

에포크당 항상 하나의 체크포인트 블록이 있으며, 한 블록이 여러 에포크의 체크포인트가 될 수 있다.

![Beacon-Chain-Checkpoints.jpg](../../images/2023-02-06-TheMerge/Beacon-Chain-Checkpoints.jpg.webp)

{: .align-center}

위 그림과 같이 65~128슬롯이 비어있어, 에포크 2 체크포인트는 슬롯 128(64 *2)의 블록이 되어야 하지만, 슬롯이 없기 때문에 64 슬롯이 다시 체크포인트가 되고, 에포크 3도 마찬가지로 192(64 *3)이 되어야 하지만 슬롯이 없기 때문에 180이 체크포인트가 된다.

여기서 체크포인트를 결정하는 로직은 FFG Vote라고 부르는 투표를 진행한다. LMD GHOST의 경우 정해진 검증자만 진행하지만, FFG Vote는 모든 검증자가 에포크마다 한다.

체크포인트가 2/3이상의 투표를 얻는다면, 이 체크포인트는 justified되었다고 정의하고, justified된 체크포인트의 다음 체크포인트가 justified되면 이전의 체크포인트는 finalized되며, Finality를 갖는다.



















<div class="notice">
  <h5>Reference</h5>
  1) <a>https://ethereum.org/ko/upgrades/merge/</a>
  <br>
  2) <a>https://medium.com/onther-tech/%EC%9D%B4%EB%8D%94%EB%A6%AC%EC%9B%802-0-%EA%B9%8A%EC%9D%B4%EB%B3%B4%EA%B8%B0-%EC%8B%9C%EB%A6%AC%EC%A6%88-eth-2-0-explained-phase-0-1%ED%8E%B8-74ee5659a40a</a>
  <br>
  3) <a>https://ethos.dev/beacon-chain</a>
</div>